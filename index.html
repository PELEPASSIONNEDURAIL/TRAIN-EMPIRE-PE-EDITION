<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>TRAIN EMPIRE ‚Äî PE Edition</title>
    <link rel="stylesheet" href="assets/css/global.css">
    <link rel="stylesheet" href="assets/css/index.css">
    <style>
        :root {
            --bg: #0b0b0c;
            --panel: #111;
            --muted: #bdbdbd;
            --accent: #1e90ff;
            --danger: #ff4d4d;
        }

        body {
            background: var(--bg);
            color: #eee;
            font-family: Inter, Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        header {
            background: #111;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4);
        }

        header h1 {
            margin: 0;
            font-size: 1.4rem;
        }

        nav a {
            color: #ddd;
            text-decoration: none;
            margin-left: 15px;
            font-weight: 500;
        }

        nav a.active {
            color: var(--accent);
        }

        main {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 10px;
        }

        section.panel {
            background: var(--panel);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        h2 {
            margin-top: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 14px;
        }

        th,
        td {
            border: 1px solid #222;
            padding: 6px;
            text-align: center;
        }

        .train-card {
            display: flex;
            align-items: flex-end;
            gap: 15px;
            background: #1a1a1a;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 15px;
        }

        .train-image {
            display: flex;
            align-items: flex-end;
            height: 80px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .train-image img {
            height: 100%;
            margin-right: 3px;
        }

        .train-info {
            flex: 1;
        }

        .train-info h3 {
            margin: 0;
            font-size: 1rem;
            color: var(--accent);
        }

        .train-info p {
            margin: 4px 0;
            font-size: 0.9rem;
        }

        footer {
            text-align: center;
            padding: 15px;
            background: #111;
            color: var(--muted);
            font-size: 0.8rem;
        }
    </style>
</head>

<body>

    <header>
        <h1>üöÜ TRAIN <span style="color:var(--accent)">EMPIRE</span> <small>PE Edition</small></h1>
        <nav>
            <a href="index.html" class="active">Accueil</a>
            <a href="create_rame.html">Cr√©er rame</a>
            <a href="create_trajet.html">Cr√©er trajet</a>
            <a href="create_ligne.html">Lignes</a>
        </nav>
    </header>

    <main>
        <!-- Tableau des trains en circulation -->
        <section class="panel">
            <h2>üöÇ Trains en circulation</h2>
            <div id="train-list">
                <!-- Les trains actifs seront inject√©s ici -->
            </div>
        </section>

        <!-- Stats -->
        <section class="panel">
            <h2>üìä Statistiques globales</h2>
            <table>
                <thead>
                    <tr>
                        <th>Fret total</th>
                        <th>Voyageurs</th>
                        <th>Trains actifs</th>
                        <th>Incidents</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td id="stat-fret">0 t</td>
                        <td id="stat-voyageurs">0</td>
                        <td id="stat-trains">0</td>
                        <td id="stat-incidents">0</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- Bouton Hub -->
        <div style="text-align:center; margin:20px;">
            <button onclick="location.href='hub.html'"
                style="padding:10px 20px; font-size:1rem; border-radius:5px; cursor:pointer; background:var(--accent); color:#fff; border:none;">
                Acc√©der au Hub des pages
            </button>
        </div>
    </main>

    <footer>
        ¬© 2025 PE ‚Äî TRAIN EMPIRE PE Edition
    </footer>

    <script>
        // Chargement des donn√©es sauvegard√©es
        const rames = JSON.parse(localStorage.getItem('ramesExistantes')) || [];
        const trajets = JSON.parse(localStorage.getItem('trajetsExistants')) || [];

        const trainList = document.getElementById('train-list');
        const statTrains = document.getElementById('stat-trains');

        function renderTrains() {
            trainList.innerHTML = '';
            if (trajets.length === 0) {
                trainList.innerHTML = '<p>Aucun train en circulation</p>';
                statTrains.textContent = '0';
                return;
            }

            trajets.forEach(trajet => {
                // On ne prend que gare d√©part et arriv√©e
                const depart = trajet.ligne ? trajet.ligne.gareDepart : 'N/A';
                const arrivee = trajet.ligne ? trajet.ligne.gareArrivee : 'N/A';
                const heureDepart = trajet.horaireDepart || '--:--';

                const rame = trajet.rame || {};
                const rameImgs = (rame.engins || []).map(e => `<img src="${e.image}" alt="${e.nom}">`).join('');

                const card = document.createElement('div');
                card.className = 'train-card';
                card.innerHTML = `
          <div class="train-image">${rameImgs}</div>
          <div class="train-info">
            <h3>${trajet.nom || 'Train sans nom'}</h3>
            <p>üïí D√©part pr√©vu : ${heureDepart}</p>
            <p>üöâ ${depart} ‚û°Ô∏è ${arrivee}</p>
          </div>
        `;
                trainList.appendChild(card);
            });

            statTrains.textContent = trajets.length.toString();
        }

        renderTrains();
    </script>

    <!-- Scripts externes -->
    <script src="js/storage.js"></script>
    <script src="js/rame.js"></script>
    <script src="js/trajet.js"></script>
    <script src="js/ligne.js"></script>
    <script src="js/traffic.js"></script>
    <script src="js/main.js"></script>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCZ0aKxn8Nxao8vlluD0nTbBssG7lzSwPo",
            authDomain: "rail-empire-b5278.firebaseapp.com",
            projectId: "rail-empire-b5278",
            storageBucket: "rail-empire-b5278.firebasestorage.app",
            messagingSenderId: "391417610159",
            appId: "1:391417610159:web:18c8ec8b692d9cbee0b95a",
            measurementId: "G-TME87RHCTC"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ----- WRAPPERS AUTH -----
        window.authCreerCompte = async (pseudo, mdp) => {
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, pseudo + "@fakeemail.com", mdp);
                console.log("Compte cr√©√© :", userCredential.user);
                return true;
            } catch (error) {
                console.error(error);
                return false;
            }
        };

        window.authConnexion = async (pseudo, mdp) => {
            try {
                const userCredential = await signInWithEmailAndPassword(auth, pseudo + "@fakeemail.com", mdp);
                console.log("Connect√© :", userCredential.user);
                return { uid: userCredential.user.uid, email: userCredential.user.email };
            } catch (error) {
                console.error(error);
                return null;
            }
        };

        // Exemple Firestore
        async function ajouterTrain(id, nom, type) {
            await setDoc(doc(db, "trains", id), {
                nom: nom,
                type: type,
                dateCreation: new Date().toISOString()
            });
            console.log("Train ajout√© !");
        }

        async function listerTrains() {
            const querySnapshot = await getDocs(collection(db, "trains"));
            querySnapshot.forEach((doc) => {
                console.log(doc.id, "=>", doc.data());
            });
        }

        // Test
        ajouterTrain("T001", "TGV Express", "Voyageur");
        listerTrains();
    </script>

    <!-- MENU CONNEXION / INSCRIPTION -->
    <div id="menuConnexion">
        <div id="menuConnexionInner">
            <h2>Connexion / Inscription</h2>
            <input type="text" id="pseudo" placeholder="Pseudo">
            <input type="password" id="mdp" placeholder="Mot de passe">
            <button id="btnConnexion">Connexion</button>
            <button id="btnInscription">Inscription</button>
            <button id="btnSkipDev" style="background:#ff5722;">DEV / Skip</button>
            <p id="menuMsg" style="color:yellow;margin-top:10px;"></p>
        </div>
    </div>

    <script>
        window.onload = () => {
            const menu = document.getElementById('menuConnexion');
            const msg = document.getElementById('menuMsg');
            const jeu = document.getElementById('jeu');
            if (jeu) jeu.style.display = 'none';

            async function inscriptionWrapper() {
                const pseudo = document.getElementById('pseudo').value.trim();
                const mdp = document.getElementById('mdp').value.trim();
                if (!pseudo || !mdp) { msg.textContent = "Remplis tous les champs !"; return; }

                msg.textContent = "Cr√©ation du compte...";
                const succes = await window.authCreerCompte(pseudo, mdp);
                if (succes) {
                    msg.textContent = "Compte cr√©√© ! Connecte-toi maintenant.";
                } else {
                    msg.textContent = "Pseudo d√©j√† utilis√©.";
                }
            }

            async function connexionWrapper() {
                const pseudo = document.getElementById('pseudo').value.trim();
                const mdp = document.getElementById('mdp').value.trim();
                if (!pseudo || !mdp) { msg.textContent = "Remplis tous les champs !"; return; }

                msg.textContent = "Connexion...";
                const dataJoueur = await window.authConnexion(pseudo, mdp);
                if (dataJoueur) {
                    menu.style.display = 'none';
                    if (jeu) jeu.style.display = 'block';
                    msg.textContent = "";
                    if (window.chargerDonnees) await window.chargerDonnees(pseudo);
                    console.log("Joueur connect√© :", pseudo, dataJoueur);
                } else {
                    msg.textContent = "Pseudo ou mot de passe incorrect.";
                }
            }

            // BOUTON DEV / SKIP
            function skipDev() {
                menu.style.display = 'none';
                if (jeu) jeu.style.display = 'block';
                console.log("DEV : Skip menu, acc√®s direct √† l'index");
            }

            document.getElementById('btnInscription').addEventListener('click', inscriptionWrapper);
            document.getElementById('btnConnexion').addEventListener('click', connexionWrapper);
            document.getElementById('btnSkipDev').addEventListener('click', skipDev);
        };

        // Styles overlay
        const style = document.createElement('style');
        style.textContent = `
  #menuConnexion {
    position: fixed; top:0; left:0; width:100%; height:100%;
    display:flex; justify-content:center; align-items:center;
    backdrop-filter: blur(5px); background: rgba(0,0,0,0.5); z-index: 9999;
  }
  #menuConnexionInner {
    background:#111; color:#eee; padding:30px; border-radius:10px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.6); text-align:center; min-width:300px;
  }
  #menuConnexion input {
    display:block; width:80%; margin:10px auto; padding:8px; border-radius:5px; border:none;
    font-size:1rem;
  }
  #menuConnexion button {
    padding:8px 15px; margin:5px; border-radius:5px; border:none;
    cursor:pointer; background: var(--accent); color:#fff; font-weight:600;
  }
  #menuConnexion button:hover { background: #1c7be0; }
  #btnSkipDev:hover { background: #ff7043; }
`;
        document.head.appendChild(style);
        window.addEventListener("DOMContentLoaded", () => {
            if (window.updatePlayerOnOpen) {
                updatePlayerOnOpen().then(data => {
                    console.log("Joueur charg√© et game mis √† jour :", data);
                });
            }
        });
    </script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";

        // Config Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCZ0aKxn8Nxao8vlluD0nTbBssG7lzSwPo",
            authDomain: "rail-empire-b5278.firebaseapp.com",
            projectId: "rail-empire-b5278",
            storageBucket: "rail-empire-b5278.firebasestorage.app",
            messagingSenderId: "391417610159",
            appId: "1:391417610159:web:18c8ec8b692d9cbee0b95a",
            measurementId: "G-TME87RHCTC"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // Transforme le pseudo en email fictif pour Firebase
        function pseudoToEmail(pseudo) {
            return `${pseudo.replace(/\s+/g, '').toLowerCase()}@trainempire.fake`;
        }

        // Cr√©ation d‚Äôun compte
        window.authCreerCompte = async function (pseudo, mdp) {
            try {
                const email = pseudoToEmail(pseudo);
                const userCredential = await createUserWithEmailAndPassword(auth, email, mdp);
                console.log("Compte cr√©√© :", userCredential.user.uid);
                return true;
            } catch (error) {
                console.error("Erreur cr√©ation compte :", error.code, error.message);
                return false;
            }
        }

        // Connexion
        window.authConnexion = async function (pseudo, mdp) {
            try {
                const email = pseudoToEmail(pseudo);
                const userCredential = await signInWithEmailAndPassword(auth, email, mdp);
                console.log("Connect√© :", userCredential.user.uid);
                return { uid: userCredential.user.uid, email: userCredential.user.email };
            } catch (error) {
                console.error("Erreur connexion :", error.code, error.message);
                return null;
            }
        }
    </script>

</body>

</html>